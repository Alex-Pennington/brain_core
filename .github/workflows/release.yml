name: Build and Release

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Base version (e.g., v1.0.1)'
        required: true
        default: 'v1.0.1'

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version info
        id: version
        shell: pwsh
        run: |
          # Read base version from VERSION file
          $baseVersion = "v" + (Get-Content "VERSION" -Raw).Trim()
          
          # Override with tag/release/dispatch if provided
          if ("${{ github.ref_type }}" -eq "tag") {
            $baseVersion = "${{ github.ref_name }}"
          }
          if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ github.event.inputs.version }}" -ne "") {
            $baseVersion = "${{ github.event.inputs.version }}"
          }
          if ("${{ github.event_name }}" -eq "release") {
            $baseVersion = "${{ github.event.release.tag_name }}"
          }
          
          $buildNum = "${{ github.run_number }}"
          $commitShort = "${{ github.sha }}".Substring(0, 7)
          $fullVersion = "$baseVersion-build.$buildNum-$commitShort"
          $fileVersion = "$baseVersion-build$buildNum-$commitShort"
          
          Write-Host "Base Version: $baseVersion"
          Write-Host "Full Version: $fullVersion"
          
          echo "base=$baseVersion" >> $env:GITHUB_OUTPUT
          echo "build=$buildNum" >> $env:GITHUB_OUTPUT
          echo "commit=$commitShort" >> $env:GITHUB_OUTPUT
          echo "full=$fullVersion" >> $env:GITHUB_OUTPUT
          echo "file=$fileVersion" >> $env:GITHUB_OUTPUT

      - name: Setup MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc

      - name: Build
        shell: msys2 {0}
        env:
          VERSION_STRING: ${{ steps.version.outputs.full }}
        run: |
          # Create version header
          echo "#ifndef VERSION_H" > src/version.h
          echo "#define VERSION_H" >> src/version.h
          echo "#define VERSION_STRING \"${VERSION_STRING}\"" >> src/version.h
          echo "#endif" >> src/version.h
          
          g++ -std=c++17 -O2 -I. -Im188110a -D_USE_MATH_DEFINES -DWIN32 \
            -o brain_modem_server.exe \
            src/main.cpp \
            m188110a/de110a.cpp \
            m188110a/eq110a.cpp \
            m188110a/g110a.cpp \
            m188110a/in110a.cpp \
            m188110a/ptx110a.cpp \
            m188110a/rxm110a.cpp \
            m188110a/t110a.cpp \
            m188110a/txm110a.cpp \
            m188110a/v110a.cpp \
            -lws2_32 -static -static-libgcc -static-libstdc++
          echo "Build successful!"
          ls -la brain_modem_server.exe

      - name: Create release package
        shell: pwsh
        env:
          VERSION_FULL: ${{ steps.version.outputs.full }}
          VERSION_FILE: ${{ steps.version.outputs.file }}
          BUILD_NUM: ${{ steps.version.outputs.build }}
          COMMIT_SHORT: ${{ steps.version.outputs.commit }}
        run: |
          New-Item -ItemType Directory -Path "release" -Force | Out-Null
          New-Item -ItemType Directory -Path "release/tx_pcm_out" -Force | Out-Null
          Copy-Item "brain_modem_server.exe" "release/"
          
          # Create simple README
          $readme = "# Paul Brain Modem Core - Headless TCP Server`n"
          $readme += "Version: $env:VERSION_FULL`n"
          $readme += "Build: $env:BUILD_NUM`n"
          $readme += "Commit: $env:COMMIT_SHORT`n`n"
          $readme += "## Quick Start`n"
          $readme += "1. Run: brain_modem_server.exe`n"
          $readme += "2. Control port: localhost:3999`n"
          $readme += "3. Data port: localhost:3998`n"
          $readme | Out-File -FilePath "release/README.md" -Encoding UTF8
          
          $zipName = "brain_modem_server_$env:VERSION_FILE.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path "release/*" -DestinationPath $zipName -CompressionLevel Optimal
          Write-Host "Created: $zipName"

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            brain_modem_server_*.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Paul Brain Modem Core ${{ steps.version.outputs.full }}"
          tag_name: ${{ steps.version.outputs.full }}
          body: |
            ## Paul Brain Modem Core - MIL-STD-188-110A Modem Server
            
            **Version:** `${{ steps.version.outputs.full }}`
            **Build:** `${{ steps.version.outputs.build }}`
            **Commit:** `${{ steps.version.outputs.commit }}`
            
            ### Features
            - Headless TCP server for automated testing
            - Control port: 3999, Data port: 3998
            - Supports all 13 MIL-STD-188-110A modes
            
            ### Verification
            ```bash
            gh attestation verify brain_modem_server_${{ steps.version.outputs.file }}.zip --owner Alex-Pennington
            ```
          files: |
            brain_modem_server_*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
