name: Build and Release

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Base version (e.g., v1.0.1)'
        required: true
        default: 'v1.0.1'

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win64
            artifact: brain_modem_server.exe
            shell: msys2 {0}
          # Uncomment when Linux library is added to lib/linux64/
          # - os: ubuntu-latest
          #   platform: linux64
          #   artifact: brain_modem_server
          #   shell: bash
          # Uncomment when macOS library is added to lib/macos64/
          # - os: macos-latest
          #   platform: macos64
          #   artifact: brain_modem_server
          #   shell: bash
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version info
        id: version
        shell: bash
        run: |
          # Read base version from VERSION file
          BASE_VERSION="v$(cat VERSION | tr -d '[:space:]')"
          
          # Override with tag/release/dispatch if provided
          if [ "${{ github.ref_type }}" = "tag" ]; then
            BASE_VERSION="${{ github.ref_name }}"
          fi
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            BASE_VERSION="${{ github.event.inputs.version }}"
          fi
          if [ "${{ github.event_name }}" = "release" ]; then
            BASE_VERSION="${{ github.event.release.tag_name }}"
          fi
          
          BUILD_NUM="${{ github.run_number }}"
          COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          FULL_VERSION="$BASE_VERSION-build.$BUILD_NUM-$COMMIT_SHORT"
          FILE_VERSION="$BASE_VERSION-build$BUILD_NUM-$COMMIT_SHORT"
          
          echo "Base Version: $BASE_VERSION"
          echo "Full Version: $FULL_VERSION"
          
          echo "base=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "full=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "file=$FILE_VERSION" >> $GITHUB_OUTPUT

      - name: Setup MinGW (Windows)
        if: matrix.os == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc

      - name: Extract source from history (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          # Extract source from git history (commit before source removal)
          git checkout 83c9c57 -- m188110a/
          ls -la m188110a/

      - name: Build (Windows)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        env:
          VERSION_STRING: ${{ steps.version.outputs.full }}
        run: |
          # Create version header
          echo "#ifndef VERSION_H" > src/version.h
          echo "#define VERSION_H" >> src/version.h
          echo "#define VERSION_STRING \"${VERSION_STRING}\"" >> src/version.h
          echo "#endif" >> src/version.h
          
          # Build static library from source
          echo "Building static library..."
          mkdir -p lib/win64
          for src in m188110a/*.cpp; do
            obj=$(basename "$src" .cpp).o
            echo "  Compiling $src -> $obj"
            g++ -c -std=c++17 -O2 -Im188110a -D_USE_MATH_DEFINES -DWIN32 -o "$obj" "$src"
          done
          ar rcs lib/win64/libm188110a.a *.o
          rm -f *.o
          echo "Library built: $(ls -la lib/win64/libm188110a.a)"
          
          # Build main executable
          g++ -std=c++17 -O2 -I. -Iinclude -Iinclude/m188110a -D_USE_MATH_DEFINES -DWIN32 \
            -o brain_modem_server.exe \
            src/main.cpp \
            -Llib/win64 -lm188110a \
            -lws2_32 -static -static-libgcc -static-libstdc++
          echo "Build successful!"
          ls -la brain_modem_server.exe

      - name: Build (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        env:
          VERSION_STRING: ${{ steps.version.outputs.full }}
        run: |
          # Create version header
          cat > src/version.h << EOF
          #ifndef VERSION_H
          #define VERSION_H
          #define VERSION_STRING "${VERSION_STRING}"
          #endif
          EOF
          
          g++ -std=c++17 -O2 -I. -Iinclude -Iinclude/m188110a -D_USE_MATH_DEFINES \
            -o brain_modem_server \
            src/main.cpp \
            -Llib/linux64 -lm188110a \
            -lpthread -static-libgcc -static-libstdc++
          echo "Build successful!"
          ls -la brain_modem_server

      - name: Build (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        env:
          VERSION_STRING: ${{ steps.version.outputs.full }}
        run: |
          # Create version header
          cat > src/version.h << EOF
          #ifndef VERSION_H
          #define VERSION_H
          #define VERSION_STRING "${VERSION_STRING}"
          #endif
          EOF
          
          g++ -std=c++17 -O2 -I. -Iinclude -Iinclude/m188110a -D_USE_MATH_DEFINES \
            -o brain_modem_server \
            src/main.cpp \
            -Llib/macos64 -lm188110a \
            -lpthread
          echo "Build successful!"
          ls -la brain_modem_server

      - name: Create release package
        shell: bash
        env:
          VERSION_FULL: ${{ steps.version.outputs.full }}
          VERSION_FILE: ${{ steps.version.outputs.file }}
          BUILD_NUM: ${{ steps.version.outputs.build }}
          COMMIT_SHORT: ${{ steps.version.outputs.commit }}
          PLATFORM: ${{ matrix.platform }}
          ARTIFACT: ${{ matrix.artifact }}
        run: |
          mkdir -p release/tx_pcm_out
          cp $ARTIFACT release/
          
          # Create README
          cat > release/README.md << EOF
          # Paul Brain Modem Core - Headless TCP Server
          Version: $VERSION_FULL
          Platform: $PLATFORM
          Build: $BUILD_NUM
          Commit: $COMMIT_SHORT

          ## Quick Start
          1. Run: ./$ARTIFACT
          2. Control port: localhost:3999
          3. Data port: localhost:3998
          EOF
          
          ZIP_NAME="brain_modem_server_${VERSION_FILE}_${PLATFORM}.zip"
          cd release && zip -r "../$ZIP_NAME" . && cd ..
          echo "Created: $ZIP_NAME"
          
          # Store zip name for later steps
          echo "$ZIP_NAME" > zip_name.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: brain_modem_server-${{ matrix.platform }}
          path: brain_modem_server_*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version info
        id: version
        shell: bash
        run: |
          BASE_VERSION="v$(cat VERSION | tr -d '[:space:]')"
          if [ "${{ github.ref_type }}" = "tag" ]; then
            BASE_VERSION="${{ github.ref_name }}"
          fi
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            BASE_VERSION="${{ github.event.inputs.version }}"
          fi
          if [ "${{ github.event_name }}" = "release" ]; then
            BASE_VERSION="${{ github.event.release.tag_name }}"
          fi
          
          BUILD_NUM="${{ github.run_number }}"
          COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          FULL_VERSION="$BASE_VERSION-build.$BUILD_NUM-$COMMIT_SHORT"
          FILE_VERSION="$BASE_VERSION-build$BUILD_NUM-$COMMIT_SHORT"
          
          echo "full=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "file=$FILE_VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT_SHORT" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release files
        run: |
          mkdir -p release_files
          find artifacts -name "*.zip" -exec cp {} release_files/ \;
          ls -la release_files/

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: release_files/*.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Paul Brain Modem Core ${{ steps.version.outputs.full }}"
          tag_name: ${{ steps.version.outputs.full }}
          body: |
            ## Paul Brain Modem Core - MIL-STD-188-110A Modem Server
            
            **Version:** `${{ steps.version.outputs.full }}`
            **Build:** `${{ steps.version.outputs.build }}`
            **Commit:** `${{ steps.version.outputs.commit }}`
            
            ### Downloads
            | Platform | File |
            |----------|------|
            | Windows x64 | `brain_modem_server_${{ steps.version.outputs.file }}_win64.zip` |
            | Linux x64 | `brain_modem_server_${{ steps.version.outputs.file }}_linux64.zip` |
            | macOS x64 | `brain_modem_server_${{ steps.version.outputs.file }}_macos64.zip` |
            
            ### Features
            - Headless TCP server for automated testing
            - Control port: 3999, Data port: 3998
            - Supports all 13 MIL-STD-188-110A modes
            
            ### Verification
            ```bash
            gh attestation verify <filename>.zip --owner Alex-Pennington
            ```
          files: release_files/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

